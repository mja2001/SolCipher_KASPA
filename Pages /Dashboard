import React, { useState, useEffect } from 'react';
import { Button } from "@/components/ui/button";
import { Send, Eye, Wallet, Plus, Shield, Zap } from 'lucide-react';
import { toast } from 'sonner';
import { motion } from 'framer-motion';
import { base44 } from '@/api/base44Client';

import Header from '@/components/solcipher/Header';
import WalletCard from '@/components/solcipher/WalletCard';
import NetworkStats from '@/components/solcipher/NetworkStats';
import TransactionHistory from '@/components/solcipher/TransactionHistory';
import PrivacyAnalytics from '@/components/solcipher/PrivacyAnalytics';
import SendTransaction from '@/components/solcipher/SendTransaction';
import ReceiveAddress from '@/components/solcipher/ReceiveAddress';
import WalletSetup from '@/components/solcipher/WalletSetup';
import Settings from '@/components/solcipher/Settings';

export default function Dashboard() {
  const [wallet, setWallet] = useState(null);
  const [balance, setBalance] = useState({ total: 0, public: 0, private: 0, usdValue: 0 });
  const [transactions, setTransactions] = useState([]);
  const [isConnected, setIsConnected] = useState(true);
  const [isLoadingBalance, setIsLoadingBalance] = useState(false);
  const [networkStats, setNetworkStats] = useState({
    blockRate: '1.0',
    dagTips: 12,
    blueScore: 45892103,
    privacyTxCount: 1247
  });

  // Modal states
  const [showWalletSetup, setShowWalletSetup] = useState(false);
  const [showSendModal, setShowSendModal] = useState(false);
  const [showReceiveModal, setShowReceiveModal] = useState(false);
  const [showSettings, setShowSettings] = useState(false);

  // Load wallet from storage on mount
  useEffect(() => {
    const savedWallet = localStorage.getItem('solcipher_wallet');
    if (savedWallet) {
      const parsed = JSON.parse(savedWallet);
      setWallet(parsed);
      // Simulate balance
      setBalance({
        total: 1250.75,
        public: 750.25,
        private: 500.50,
        usdValue: 125.08
      });
      loadTransactions();
    }
  }, []);

  const loadTransactions = async () => {
    try {
      const txs = await base44.entities.Transaction.list('-created_date', 10);
      setTransactions(txs);
    } catch (error) {
      // Use mock data if no transactions exist
      setTransactions([
        {
          id: '1',
          tx_id: 'abc123def456789',
          type: 'send',
          amount: 50.5,
          recipient_address: 'kaspa:qz123...abc',
          privacy_level: 'enhanced',
          status: 'confirmed',
          created_date: new Date(Date.now() - 3600000).toISOString()
        },
        {
          id: '2',
          tx_id: 'xyz789ghi012345',
          type: 'receive',
          amount: 125.0,
          sender_address: 'kaspa:qr456...def',
          privacy_level: 'standard',
          status: 'confirmed',
          created_date: new Date(Date.now() - 7200000).toISOString()
        },
        {
          id: '3',
          tx_id: 'mno456pqr789012',
          type: 'send',
          amount: 25.25,
          recipient_address: 'kaspa:qz789...ghi',
          privacy_level: 'maximum',
          status: 'mixing',
          created_date: new Date(Date.now() - 300000).toISOString()
        }
      ]);
    }
  };

  const handleWalletCreated = (newWallet) => {
    setWallet(newWallet);
    localStorage.setItem('solcipher_wallet', JSON.stringify(newWallet));
    setBalance({
      total: 0,
      public: 0,
      private: 0,
      usdValue: 0
    });
    toast.success('Wallet ready! Get testnet KAS from a faucet to start.');
  };

  const handleRefreshBalance = async () => {
    setIsLoadingBalance(true);
    await new Promise(resolve => setTimeout(resolve, 1500));
    setBalance(prev => ({
      ...prev,
      total: prev.total + Math.random() * 10,
      public: prev.public + Math.random() * 5
    }));
    setIsLoadingBalance(false);
    toast.success('Balance updated');
  };

  const handleSendTransaction = async (tx) => {
    try {
      await base44.entities.Transaction.create({
        tx_id: tx.tx_id,
        type: 'send',
        amount: tx.amount,
        recipient_address: tx.recipient_address,
        privacy_level: tx.privacy_level,
        status: 'confirmed',
        fee: tx.fee,
        anonymity_set_size: tx.anonymity_set_size,
        mixing_rounds: tx.mixing_rounds
      });
      
      setBalance(prev => ({
        ...prev,
        total: prev.total - tx.amount - tx.fee,
        private: prev.private + tx.amount
      }));
      
      loadTransactions();
      toast.success('Transaction sent successfully!');
    } catch (error) {
      console.log('Transaction saved locally');
    }
  };

  const handleLogout = () => {
    localStorage.removeItem('solcipher_wallet');
    setWallet(null);
    setBalance({ total: 0, public: 0, private: 0, usdValue: 0 });
    setTransactions([]);
    toast.success('Wallet disconnected');
  };

  const handleDeleteWallet = () => {
    handleLogout();
  };

  // If no wallet, show setup prompt
  if (!wallet) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950">
        <Header isConnected={isConnected} />
        
        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          <motion.div 
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="text-center max-w-2xl mx-auto"
          >
            {/* Hero */}
            <div className="mb-12">
              <div className="relative inline-block mb-6">
                <div className="w-24 h-24 bg-gradient-to-br from-purple-500 to-cyan-500 rounded-3xl flex items-center justify-center mx-auto">
                  <Shield className="w-12 h-12 text-white" />
                </div>
                <div className="absolute -bottom-2 -right-2 w-10 h-10 bg-cyan-400 rounded-xl flex items-center justify-center">
                  <Zap className="w-5 h-5 text-slate-900" />
                </div>
              </div>
              
              <h1 className="text-4xl md:text-5xl font-bold text-white mb-4">
                Privacy at{' '}
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400">
                  Kaspa Speed
                </span>
              </h1>
              
              <p className="text-slate-400 text-lg mb-8 max-w-md mx-auto">
                The first privacy solution built specifically for Kaspa's BlockDAG. 
                Private transactions confirmed in seconds.
              </p>

              <div className="flex flex-col sm:flex-row gap-4 justify-center">
                <Button
                  onClick={() => setShowWalletSetup(true)}
                  className="bg-gradient-to-r from-purple-600 to-cyan-600 hover:from-purple-700 hover:to-cyan-700 text-white px-8 h-12 text-lg"
                >
                  <Plus className="w-5 h-5 mr-2" />
                  Create Wallet
                </Button>
                <Button
                  variant="outline"
                  onClick={() => setShowWalletSetup(true)}
                  className="border-slate-600 text-slate-300 hover:bg-slate-800 px-8 h-12 text-lg"
                >
                  <Wallet className="w-5 h-5 mr-2" />
                  Import Wallet
                </Button>
              </div>
            </div>

            {/* Features */}
            <div className="grid md:grid-cols-3 gap-6 mt-16">
              {[
                { icon: Zap, title: '~5 Second Privacy', desc: 'Fast mixing through DAG architecture' },
                { icon: Shield, title: 'Stealth Addresses', desc: 'One-time addresses for each transaction' },
                { icon: Eye, title: 'Amount Obfuscation', desc: 'Hidden values with cryptographic proofs' }
              ].map((feature, i) => (
                <motion.div
                  key={feature.title}
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.2 + i * 0.1 }}
                  className="bg-slate-800/30 rounded-2xl p-6 border border-slate-700/30"
                >
                  <div className="w-12 h-12 bg-gradient-to-br from-purple-500/20 to-cyan-500/20 rounded-xl flex items-center justify-center mb-4 mx-auto">
                    <feature.icon className="w-6 h-6 text-cyan-400" />
                  </div>
                  <h3 className="text-white font-semibold mb-2">{feature.title}</h3>
                  <p className="text-slate-400 text-sm">{feature.desc}</p>
                </motion.div>
              ))}
            </div>
          </motion.div>
        </main>

        <WalletSetup
          isOpen={showWalletSetup}
          onClose={() => setShowWalletSetup(false)}
          onWalletCreated={handleWalletCreated}
        />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950">
      <Header 
        isConnected={isConnected}
        wallet={wallet}
        onSettingsClick={() => setShowSettings(true)}
        onLogout={handleLogout}
      />
      
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        {/* Quick Actions */}
        <div className="flex flex-wrap gap-3 mb-6">
          <Button
            onClick={() => setShowSendModal(true)}
            className="bg-gradient-to-r from-purple-600 to-cyan-600 hover:from-purple-700 hover:to-cyan-700"
          >
            <Send className="w-4 h-4 mr-2" />
            Send Privately
          </Button>
          <Button
            variant="outline"
            onClick={() => setShowReceiveModal(true)}
            className="border-slate-700 text-slate-300 hover:bg-slate-800"
          >
            <Eye className="w-4 h-4 mr-2" />
            Receive
          </Button>
        </div>

        {/* Main Grid */}
        <div className="grid lg:grid-cols-3 gap-6">
          {/* Left Column */}
          <div className="lg:col-span-2 space-y-6">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
            >
              <WalletCard 
                wallet={wallet}
                balance={balance}
                isLoading={isLoadingBalance}
                onRefresh={handleRefreshBalance}
              />
            </motion.div>
            
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.1 }}
            >
              <TransactionHistory transactions={transactions} />
            </motion.div>
          </div>

          {/* Right Column */}
          <div className="space-y-6">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.2 }}
            >
              <NetworkStats stats={networkStats} isConnected={isConnected} />
            </motion.div>
            
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.3 }}
            >
              <PrivacyAnalytics />
            </motion.div>
          </div>
        </div>
      </main>

      {/* Modals */}
      <SendTransaction
        isOpen={showSendModal}
        onClose={() => setShowSendModal(false)}
        wallet={wallet}
        balance={balance}
        onSend={handleSendTransaction}
      />

      <ReceiveAddress
        isOpen={showReceiveModal}
        onClose={() => setShowReceiveModal(false)}
        wallet={wallet}
      />

      <Settings
        isOpen={showSettings}
        onClose={() => setShowSettings(false)}
        wallet={wallet}
        onDelete={handleDeleteWallet}
      />
    </div>
  );
}
